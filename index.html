<!doctype html>
<html lang="pl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>FreeFlow — Voice to Order</title>
  <meta name="description" content="Zamów głosem - restauracje, taxi, hotele" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#ff8a30" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="FreeFlow" />
  <meta name="mobile-web-app-capable" content="yes" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  
  <!-- Icons -->
  <link rel="icon" type="image/png" href="images/Freeflow-logo.png" />
  <link rel="apple-touch-icon" href="images/Freeflowlogo.png" />
  
  <!-- Preload critical resources -->
  <link rel="preload" href="images/Background.png" as="image" />
  <link rel="preload" href="images/Freeflowlogo.png" as="image" />
  <script type="module" crossorigin src="assets/index-CHbNu_13.js"></script>
  <link rel="stylesheet" crossorigin href="assets/index-i4BUNEdS.css">
</head>

<body>
  <div id="root"></div>
  
  <script>
    // TTS Interceptor i Text Cleanup
    (function() {
      let currentAudio = null;
      
      // Czyści tekst przed wysłaniem do TTS
      function cleanTextForTTS(text) {
        if (!text || typeof text !== 'string') return text;
        
        return text
          // Zamieniaj cyfry na słowa
          .replace(/\b4\b/g, 'cztery')
          .replace(/\b9\b/g, 'dziewięć')
          .replace(/\b0\b/g, 'zero')
          .replace(/\b1\b/g, 'jeden')
          .replace(/\b2\b/g, 'dwa')
          .replace(/\b3\b/g, 'trzy')
          .replace(/\b5\b/g, 'pięć')
          .replace(/\b6\b/g, 'sześć')
          .replace(/\b7\b/g, 'siedem')
          .replace(/\b8\b/g, 'osiem')
          // Usuń gwiazdki i inne problematyczne znaki
          .replace(/\*/g, '')
          .replace(/[\*]+/g, '')
          .replace(/\s+/g, ' ')
          .trim();
      }
      
      // Zatrzymuje aktualnie odtwarzane audio
      function stopCurrentAudio() {
        if (currentAudio) {
          try {
            currentAudio.pause();
            currentAudio.currentTime = 0;
          } catch (e) {
            console.log('Nie można zatrzymać audio:', e);
          }
          currentAudio = null;
        }
      }
      
      // Przechwytuje wywołania Audio
      const OriginalAudio = window.Audio;
      window.Audio = function(src) {
        stopCurrentAudio();
        const audio = new OriginalAudio(src);
        currentAudio = audio;
        return audio;
      };
      
      // Przechwytuje fetch dla OpenAI TTS
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        const [url, options] = args;
        
        // Sprawdź czy to może być wywołanie TTS
        if (url && typeof url === 'string' && 
            (url.includes('openai') || url.includes('speech') || url.includes('tts'))) {
          
          if (options && options.body) {
            try {
              let body = options.body;
              if (typeof body === 'string') {
                const data = JSON.parse(body);
                if (data.input || data.text) {
                  // Zatrzymaj aktualny dźwięk
                  stopCurrentAudio();
                  
                  // Wyczyść tekst
                  if (data.input) {
                    data.input = cleanTextForTTS(data.input);
                  }
                  if (data.text) {
                    data.text = cleanTextForTTS(data.text);
                  }
                  
                  options.body = JSON.stringify(data);
                  console.log('TTS tekst wyczyszczony:', data.input || data.text);
                }
              }
            } catch (e) {
              console.log('Nie udało się przetworzyć TTS request:', e);
            }
          }
        }
        
        return originalFetch.apply(this, args);
      };
      
      // Przechwytuje createObjectURL dla audio blob
      const originalCreateObjectURL = URL.createObjectURL;
      URL.createObjectURL = function(blob) {
        if (blob && blob.type && blob.type.startsWith('audio/')) {
          stopCurrentAudio();
        }
        return originalCreateObjectURL.apply(this, arguments);
      };
      
      console.log('TTS Interceptor załadowany - cyfry i gwiazdki będą filtrowane, audio zsynchronizowane');
    })();
  </script>

<script>
(() => {
  const BACK_URL = "https://github.com/ndoemo02/FreeFlow-FRONT/new/main"; // <--- PODMIEŃ
  const ENDPOINTS = { health:"/api/healthz", diag:"/api/diag", selftest:"/api/selftest", version:"/api/version", time:"/api/time" };

  const jfetch = async (url, timeout=8000) => {
    const ctrl = new AbortController(), to = setTimeout(() => ctrl.abort(), timeout);
    try {
      const r = await fetch(url, {signal: ctrl.signal});
      const t = await r.text(); let d; try{ d=JSON.parse(t);}catch{ d=t;}
      return { ok:r.ok, status:r.status, data:d };
    } catch(e){ return { ok:false, status:0, data:{error:e.name==="AbortError"?"timeout":e.message} }; }
    finally{ clearTimeout(to); }
  };

  const badge = document.createElement("button");
  Object.assign(badge.style, {position:"fixed", right:"12px", bottom:"12px", zIndex:9999,
    background:"#111827", color:"#fff", border:"1px solid #374151", borderRadius:"9999px",
    padding:"8px 12px", display:"flex", gap:"8px", alignItems:"center", boxShadow:"0 6px 20px rgba(0,0,0,.25)"});
  const dot = document.createElement("span");
  Object.assign(dot.style,{width:"10px", height:"10px", borderRadius:"9999px", background:"#9ca3af"});
  const label = document.createElement("span"); label.textContent="DrWeb"; label.style.fontSize="12px"; label.style.opacity=".9";
  badge.append(dot, label); document.body.appendChild(badge);

  const panel = document.createElement("div");
  Object.assign(panel.style,{position:"fixed", right:"12px", bottom:"56px", zIndex:9999, width:"min(92vw,520px)", maxHeight:"70vh",
    overflow:"auto", background:"#0b1220", color:"#fff", border:"1px solid #243046", borderRadius:"12px", padding:"12px",
    boxShadow:"0 12px 32px rgba(0,0,0,.35)", display:"none"});
  const header = document.createElement("div"); Object.assign(header.style,{display:"flex", justifyContent:"space-between", marginBottom:"8px"});
  header.innerHTML = `<div style="font-weight:600">DrWeb – diagnostyka</div>
  <div style="display:flex; gap:8px">
    <button id="drw-run" style="padding:6px 10px;border-radius:8px;background:#1f2937;color:#e5e7eb;border:1px solid #374151">Uruchom testy</button>
    <button id="drw-copy" style="padding:6px 10px;border-radius:8px;background:#1f2937;color:#e5e7eb;border:1px solid #374151">Kopiuj raport</button>
  </div>`;
  const pre = document.createElement("pre"); Object.assign(pre.style,{whiteSpace:"pre-wrap", background:"#0f172a", padding:"8px", borderRadius:"8px", fontSize:"12px", lineHeight:"1.35"});
  panel.append(header, pre); document.body.appendChild(panel);

  let report = null, busy=false;

  async function run() {
    if (!BACK_URL || busy) return;
    busy=true; const started=new Date().toISOString();
    const base = BACK_URL.replace(/\/+$/,"");
    const out = {};
    for (const [k,p] of Object.entries(ENDPOINTS)) out[k] = await jfetch(base + p);
    const ok = out.health?.ok && out.diag?.ok && out.selftest?.ok;
    report = { started, finished:new Date().toISOString(), frontendOrigin:location.origin, backendBase:base, verdict: ok?"OK":"FAIL", results: out };
    pre.textContent = JSON.stringify(report,null,2);
    dot.style.background = ok ? "#16a34a" : "#dc2626";
    busy=false;
  }

  badge.onclick = () => { panel.style.display = panel.style.display==="none" ? "block" : "none"; if (!report) run(); };
  panel.querySelector("#drw-run").onclick = run;
  panel.querySelector("#drw-copy").onclick = () => report && navigator.clipboard?.writeText(JSON.stringify(report,null,2));
})();
        </script>
  
</body>
</html>
